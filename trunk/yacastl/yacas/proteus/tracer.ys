

/* example using javascript for outputting a trace of an execution.
 * NiceTraceExp does the same as TraceExp, but exporting the result
 * as a html file with an expandable list (using javascript).
 * NiceTraceRule does the same, but for TraceRule.
 *
 * You can use this file standalone by typing Load("tracejscript"),
 * calling one of the NiceTrace.. functions and then starting up
 * netscape with trace.html.
 */


TrIndent() :=
[
/*TODO remove?
  Local(result,i);
  Set(result,"");
  For(Set(i,Length(traceStack)),i>=1,Set(i,i-1)) [Set(result, result:"    ");];
  result;
*/
  2*Length(traceStack);

];
Last(list) := list[Length(list)];


10 # Dump({_expand,_expr1,_expr2}) <--
[
      Write(expand);Space();Write(0);NewLine();
      //TODO remove? WriteString(indent);
      WriteString(String(indent):":":"Dummy":":");
      WriteString(expr1); WriteString(expr2);NewLine();
];
10 # Dump({_expand,_expr1,_expr2,_file,0}) <-- 
[
      Write(expand);Space();Write(0);NewLine();
      //TODO remove? WriteString(indent);
      WriteString(String(indent):":":"Dummy":":");
      WriteString(expr1); WriteString(expr2);NewLine();
];
20 # Dump({_expand,_expr1,_expr2,_file,_line}) <-- 
[
      Write(expand);Space();Write(line);NewLine();
      WriteString(file);NewLine();
      //TODO remove? WriteString(indent);
      WriteString(String(indent):":":"Dummy":":");
      WriteString(expr1); WriteString(expr2);NewLine();
];

TrDump():=
[
  Local(head);
  Set(head, Head(traceStack));
  ToFile(TraceFile(traceFile))
  [
    While(Not(Equals(head,{})))
    [
      Dump(Head(head));
      Set(head,Tail(head));
    ];
    Echo({"0: :end"});
  ];
];

TrEnter(_function,_expr,_file,_line) <--
[
  If(GreaterThan(Length(expr),100),Set(expr,StringMid(1,100,expr):"..."));

  DestructiveAppend(Head(traceStack),{-1,"ENTER: ",expr,file,line});
  DestructiveInsert(traceStack,1,{});
  Set(indent, TrIndent());
];
HoldArg("TrEnter",arg1);


TrLeave(_expr,_result) <--
[
  if (Length(Head(traceStack)) > 0)
  [
    TrDump();
    Set(traceStack, Tail(traceStack));
    Last(Head(traceStack))[1] := traceFile;
    Set(traceFile,traceFile+1);
  ]
  else
  [
    Set(traceStack, Tail(traceStack));
  ];
  Set(indent, TrIndent());
  DestructiveAppend(Head(traceStack),{-1,"LEAVE: ",result});
];
HoldArg("TrLeave",arg1);
HoldArg("TrLeave",arg2);


TraceFile(_i) <-- ("exp.":String(i));

ThunkToTracer() <--
[
  traceFile := 1;
  traceStack := {{}};
  indent := TrIndent();
  last:={};
  Load("trace.tmp");
  While(Length(traceStack)>1) TrLeave("STOPPED","STOPPED");
  TrDump();
  traceStack := {{{traceFile,"BEGIN",""},{-1,"END",""}}};
  traceFile := 0;
  TrDump();
];


NiceTraceExp(_expr) <--
[
  Local(res);
  res:=ToFile("trace.tmp")Eval(UnList({TraceExp,expr}));
  ThunkToTracer();
  res;
];
HoldArg("NiceTraceExp",arg1);


